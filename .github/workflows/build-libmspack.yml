name: Build libmspack for Android

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-libmspack:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        abi: [arm64-v8a, x86_64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build unzip wget

      - name: Download libmspack source
        run: |
          wget https://www.cabextract.org.uk/libmspack/libmspack-0.11alpha.zip
          unzip libmspack-0.11alpha.zip -d libmspack
          cd libmspack && ls -l

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27

      - name: Build libmspack (${{ matrix.abi }})
        run: |
          cd libmspack/libmspack-0.11alpha
          cmake -B build -S . \
            -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-24 \
            -DBUILD_SHARED_LIBS=ON
          cmake --build build --config Release
          mkdir -p ../../jniLibs/${{ matrix.abi }}
          cp build/libmspack.so ../../jniLibs/${{ matrix.abi }}/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libmspack-${{ matrix.abi }}
          path: jniLibs/${{ matrix.abi }}/libmspack.so
