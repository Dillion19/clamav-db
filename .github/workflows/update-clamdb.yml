name: Update ClamAV Database

on:
  # manual run button
  workflow_dispatch:
  # auto: every 6 hours at :17
  schedule:
    - cron: "17 */6 * * *"

permissions:
  contents: write  # needed for commit & release

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ClamAV tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clamav clamav-freshclam

      - name: Prepare config and workspace
        run: |
          mkdir -p build/clamdb

      - name: Fetch latest ClamAV databases (Cloudflare first, safe fallbacks)
        shell: bash
        run: |
          set -euo pipefail
          UA="curl/7 GitHubActions ClamAV-DB-Updater"
          OUT="build/clamdb"

          fetch_one () {
            local base="$1"
            local dest="$OUT/$base.cvd"
            # Try Cloudflare mirror first, then the classic host; try .cvd then .cld
            local urls=(
              "https://clamav-data.cdn.cloudflare.net/$base.cvd"
              "https://clamav-data.cdn.cloudflare.net/$base.cld"
              "https://database.clamav.net/$base.cvd"
              "https://database.clamav.net/$base.cld"
            )

            for u in "${urls[@]}"; do
              echo "Trying $u"
              if curl -fsSL \
                   --retry 5 --retry-all-errors \
                   --connect-timeout 10 --max-time 180 \
                   -A "$UA" -o "$dest.tmp" "$u"; then
                mv -f "$dest.tmp" "$dest"
                echo "OK: downloaded $base from $u"
                return 0
              fi
            done

            echo "ERROR: failed to download $base from all mirrors" >&2
            return 1
          }

          fetch_one main
          fetch_one daily
          fetch_one bytecode

      - name: Quick validation (informational)
        continue-on-error: true
        run: |
          for f in build/clamdb/*.cvd; do
            echo "::group::sigtool --verify-cvd $(basename "$f")"
            sigtool --verify-cvd "$f" || true
            echo "::endgroup::"
          done

      - name: Commit updated DB into repo (assets/clamav)
        run: |
          DEST="assets/clamav"
          mkdir -p "$DEST"
          cp -f build/clamdb/*.cvd "$DEST"/

          if git status --porcelain "$DEST" | grep .; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add "$DEST"
            git commit -m "Update ClamAV DB ($(date -u +%Y-%m-%dT%H:%MZ))"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Upload artifact (for this run)
        uses: actions/upload-artifact@v4
        with:
          name: clamdb
          path: build/clamdb/*.cvd

      - name: Publish/Update GitHub Release 'latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest ClamAV DB
          files: build/clamdb/*.cvd
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}