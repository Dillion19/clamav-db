name: Update ClamAV Database

on:
  workflow_dispatch:
  schedule:
    - cron: "12 */6 * * *"  # every 6 hours at :12

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Set up env
        run: |
          sudo apt-get update
          sudo apt-get install -y clamav gh
          sudo systemctl stop clamav-freshclam || true

      - name: Fetch latest ClamAV databases (tolerate errors)
        run: |
          mkdir -p db
          cat > freshclam.conf <<'EOF'
          DatabaseMirror database.clamav.net
          DatabaseDirectory db
          LogVerbose yes
          LogFile freshclam.log
          ConnectTimeout 60
          MaxAttempts 3
          EOF
          # Do not fail the job if freshclam returns a non-zero code (rate limit).
          freshclam --config-file=freshclam.conf || echo "FreshClam completed with warnings"

      - name: Show results
        run: |
          ls -lh db || true
          wc -c db/* || true
          tail -n +1 freshclam.log || true

      - name: Upload artifact (for this run)
        uses: actions/upload-artifact@v4
        with:
          name: clamav-db
          path: |
            db/main.*
            db/daily.*
            db/bytecode.*

      - name: Publish GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ts=$(date -u +"%Y%m%d-%H%M%S")
          tag="db-${ts}"
          gh release create "$tag" db/* --title "ClamAV DB $ts" --notes "Automated update"