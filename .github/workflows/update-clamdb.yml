name: Update ClamAV Database

on:
  workflow_dispatch:
  schedule:
    - cron: "17 */6 * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ClamAV tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clamav clamav-freshclam ca-certificates

      - name: Prepare config and workspace
        run: |
          mkdir -p build/clamdb
          echo "DatabaseMirror database.clamav.net" > freshclam.conf
          echo "DatabaseMirror clamav-data.cdn.cloudflare.net" >> freshclam.conf
          echo "CompressLocalDatabase yes" >> freshclam.conf
          echo "DatabaseOwner clamav" >> freshclam.conf
          echo "ScriptedUpdates yes" >> freshclam.conf
          echo "NotifyClamd no" >> freshclam.conf
          echo "ConnectTimeout 30" >> freshclam.conf
          echo "ReceiveTimeout 60" >> freshclam.conf
          echo "DNSDatabaseInfo current.cvd.clamav.net" >> freshclam.conf
          echo "DatabaseDirectory ./build/clamdb" >> freshclam.conf
          echo "AllowSupplementaryGroups yes" >> freshclam.conf

      - name: Fetch latest ClamAV databases (via freshclam)
        shell: bash
        run: |
          set -e
          echo "Running freshclam (IPv4 only, quiet mode)..."
          sudo freshclam --config-file=freshclam.conf --no-warnings -d -p ./build/clamdb/pidfile || true
          echo "Retrying manually via curl fallback..."
          for file in main daily bytecode; do
            for ext in cvd cld; do
              url="https://database.clamav.net/${file}.${ext}"
              dest="./build/clamdb/${file}.${ext}"
              echo "Trying $url..."
              if curl -fsSL --retry 5 --connect-timeout 10 -A "ClamAV-GitHubRunner" -o "$dest" "$url"; then
                echo "âœ… Downloaded $file.$ext"
                break
              fi
            done
          done

      - name: Verify database files
        run: |
          echo "Verifying downloaded databases..."
          for f in build/clamdb/*.cvd; do
            echo "::group::Verifying $(basename "$f")"
            sigtool --verify-cvd "$f" || true
            echo "::endgroup::"
          done

      - name: Commit updated DB into repo (assets/clamav)
        run: |
          DEST="assets/clamav"
          mkdir -p "$DEST"
          cp -f build/clamdb/*.cvd "$DEST"/ || true
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git status --porcelain "$DEST" | grep .; then
            git add "$DEST"
            git commit -m "Update ClamAV DB ($(date -u +%Y-%m-%dT%H:%MZ))"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Upload artifact (for this run)
        uses: actions/upload-artifact@v4
        with:
          name: clamdb
          path: build/clamdb/*.cvd

      - name: Publish/Update GitHub Release 'latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest ClamAV Database
          files: build/clamdb/*.cvd
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}