name: Update ClamAV Database

on:
  # Run it manually from the Actions tab
  workflow_dispatch:
  # And also run it a few times a day to keep things fresh
  schedule:
    - cron: "17 */8 * * *"  # every 8 hours at :17

concurrency:
  group: clamav-db
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed to publish/update a release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ClamAV and tools
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y clamav clamav-freshclam curl jq
          # Avoid the daemon trying to run on CI
          sudo systemctl stop clamav-freshclam || true

      - name: Prepare config and workspace
        run: |
          set -eux
          rm -rf db
          mkdir -p db
          cat > freshclam.conf <<'EOF'
          DatabaseMirror database.clamav.net
          DNSDatabaseInfo current.cvd.clamav.net
          CompressLocalDatabase yes
          Bytecode yes
          Foreground yes
          UpdateLogFile ./freshclam.log
          MaxAttempts 3
          ConnectTimeout 30
          EOF

      - name: Fetch latest ClamAV databases (freshclam with safe fallback)
        run: |
          set -euxo pipefail
          echo "=== Try freshclam ==="
          if ! freshclam --verbose --datadir=db --config-file=freshclam.conf; then
            echo "freshclam failed (expected sometimes on CI). Falling back to HTTPS fetch..."
          fi

          fetch() {
            local f="$1"
            local url="https://database.clamav.net/${f}"
            if [ ! -s "db/${f}" ]; then
              echo "Downloading ${f} ..."
              curl -fL --retry 5 --retry-delay 5 -o "db/${f}" "$url" || echo "WARN: manual fetch of ${f} failed"
            else
              echo "${f} already present and non-empty."
            fi
          }

          mkdir -p db
          fetch main.cvd
          fetch daily.cvd
          fetch bytecode.cvd

          echo "=== Final database directory ==="
          ls -lh db || true

          # Ensure we got at least one database file
          test -s db/main.cvd || test -s db/daily.cvd || test -s db/bytecode.cvd

      - name: Quick validation (informational)
        run: |
          set -eux
          file db/*.cvd || true
          wc -c db/*.cvd || true

      - name: Upload artifact (for this run)
        uses: actions/upload-artifact@v4
        with:
          name: clamav-db
          path: db/*.cvd
          if-no-files-found: error

      - name: Publish/Update GitHub Release "latest"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: latest
          body: "Automated ClamAV database snapshot"
          files: db/*.cvd
          draft: false
          prerelease: false
          generate_release_notes: false
          fail_on_unmatched_files: false
          update_existing: true