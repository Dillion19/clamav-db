name: Update ClamAV Database

on:
  workflow_dispatch:        # run manually
  schedule:
    - cron: "17 6 * * *"    # run daily at 06:17 UTC (change if you like)

permissions:
  contents: write           # needed to create/update Releases

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ClamAV and tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends clamav clamav-freshclam ca-certificates curl
          # make sure the daemon isn't holding the DB directory
          sudo systemctl stop clamav-freshclam || true
          sudo rm -rf /var/lib/clamav/*.cvd /var/lib/clamav/*.cld || true

      - name: Fetch latest ClamAV databases (tolerate errors)
        run: |
          set -e
          mkdir -p db
          # First try freshclam (fastest). If it fails or misses a file, fall back to HTTPS downloads.
          freshclam --verbose --datadir=db || true

          test -f db/daily.cvd    -o -f db/daily.cld    || curl -fsSLo db/daily.cvd    https://database.clamav.net/daily.cvd
          test -f db/main.cvd     -o -f db/main.cld     || curl -fsSLo db/main.cvd     https://database.clamav.net/main.cvd
          test -f db/bytecode.cvd -o -f db/bytecode.cld || curl -fsSLo db/bytecode.cvd https://database.clamav.net/bytecode.cvd

          ls -lh db

      - name: Upload artifact (for this run)
        uses: actions/upload-artifact@v4
        with:
          name: clamav-db
          path: |
            db/*.cvd
            db/*.cld

      - name: Publish GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ts=$(date -u +"%Y%m%d-%H%M%S")
          tag="latest"                         # keep a single rolling release
          gh release delete "$tag" -y || true  # remove old "latest" if it exists
          gh release create "$tag" db/* \
            --title "ClamAV DB ($ts)" \
            --notes "Automated update of ClamAV databases."