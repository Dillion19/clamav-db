name: Update ClamAV Database

on:
  workflow_dispatch: {}
  schedule:
    # Run every 6 hours; adjust if you want less/more often
    - cron: "17 */6 * * *"

permissions:
  contents: write

concurrency:
  group: clamav-db
  cancel-in-progress: true

jobs:
  update:
    name: Update ClamAV Database
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      RELEASE_TAG: latest

    steps:
      - name: Checkout (for Actions context)
        uses: actions/checkout@v4

      - name: Prepare config and workspace
        run: |
          set -euxo pipefail
          mkdir -p db

      - name: Fetch latest ClamAV databases (safe HTTPS fallback only)
        run: |
          set -euxo pipefail
          echo "=== Fetching ClamAV database files via HTTPS CDN ==="
          BASE_URL="https://database.clamav.net"

          # Prefer .cvd (container) files; .cld often returns 403 to CI/IP ranges
          need_any=0
          for f in main.cvd daily.cvd bytecode.cvd; do
            echo "::group::Download $f"
            if curl -fL --retry 5 --retry-delay 5 -o "db/$f" "$BASE_URL/$f"; then
              need_any=1
              ls -lh "db/$f" || true
            else
              echo "WARN: Failed to download $f from $BASE_URL"
            fi
            echo "::endgroup::"
          done

          echo "=== Directory contents ==="
          ls -lh db || true

          if [ "$need_any" -ne 1 ]; then
            echo "ERROR: No CVD files downloaded."
            exit 1
          fi

      - name: Quick validation (informational)
        run: |
          set -euxo pipefail
          # Ensure files exist and are >0 bytes
          for f in main.cvd daily.cvd bytecode.cvd; do
            if [ -s "db/$f" ]; then
              echo "OK: db/$f ($(stat -c%s "db/$f") bytes)"
            else
              echo "NOTE: db/$f missing (still proceeding if at least one file is present)"
            fi
          done
          du -h db/* || true

      - name: Upload artifact (for this run)
        uses: actions/upload-artifact@v4
        with:
          name: clamav-db
          path: db/*.cvd
          if-no-files-found: error
          retention-days: 7

      - name: Publish/Update GitHub Release "latest"
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.RELEASE_TAG }}
          name: "ClamAV Database (latest)"
          body: "Automated refresh of ClamAV database files (main.cvd, daily.cvd, bytecode.cvd)."
          artifacts: "db/*.cvd"
          allowUpdates: true
          replacesArtifacts: true
          artifactErrorsFailBuild: true