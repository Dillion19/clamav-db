name: Build ClamAV (arm64-v8a)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/build-clamav-arm64.yml"
      - "jniLibs/arm64-v8a/**"

concurrency:
  group: build-clamav-arm64
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ANDROID_API: "24"
      ANDROID_ABI: "arm64-v8a"
      ANDROID_NDK_VERSION: "27.3.13757024"
      NDK_DIR: "/usr/local/lib/android/sdk/ndk/27.3.13757024"
      # Change this if you want a different ClamAV version:
      CLAMAV_TAG: "clamav-1.3.1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
          add-to-path: true
          link-to-sdk: true
          local-cache: true

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake pkg-config autoconf automake libtool zip unzip

      # We only build ARM64. Copy your prebuilt third-party libs into a neutral folder
      # so CMake can discover them without trying to fetch/build anything else.
      - name: Prepare third-party libs (arm64-v8a)
        run: |
          set -euo pipefail
          mkdir -p thirdparty/arm64-v8a
          test -f jniLibs/arm64-v8a/libmspack.so || { echo "Missing jniLibs/arm64-v8a/libmspack.so"; exit 1; }
          test -f jniLibs/arm64-v8a/libxml2.so   || { echo "Missing jniLibs/arm64-v8a/libxml2.so"; exit 1; }
          cp -v jniLibs/arm64-v8a/libmspack.so thirdparty/arm64-v8a/
          cp -v jniLibs/arm64-v8a/libxml2.so   thirdparty/arm64-v8a/

      - name: Fetch ClamAV sources
        run: |
          set -euo pipefail
          git clone --depth=1 --branch "${CLAMAV_TAG}" https://github.com/Cisco-Talos/clamav.git clamav

      # Configure with CMake for Android + skip optional deps that caused errors.
      # We also point CMake at our prebuilt libxml2 & libmspack with CMAKE_*PATH.
      - name: Configure (CMake, arm64-v8a)
        working-directory: clamav
        run: |
          set -euo pipefail
          cmake -S . -B build -G Ninja \
            -D CMAKE_TOOLCHAIN_FILE="${NDK_DIR}/build/cmake/android.toolchain.cmake" \
            -D ANDROID_ABI="${ANDROID_ABI}" \
            -D ANDROID_PLATFORM="${ANDROID_API}" \
            -D CMAKE_BUILD_TYPE=Release \
            -D BUILD_SHARED_LIBS=ON \
            \
            # Hint CMake where our prebuilt .so live
            -D CMAKE_PREFIX_PATH="${GITHUB_WORKSPACE}/thirdparty/arm64-v8a" \
            -D CMAKE_LIBRARY_PATH="${GITHUB_WORKSPACE}/thirdparty/arm64-v8a" \
            -D CMAKE_SYSTEM_LIBRARY_PATH="${GITHUB_WORKSPACE}/thirdparty/arm64-v8a" \
            \
            # ClamAV optional deps we don't want to fetch/require:
            -D CMAKE_DISABLE_FIND_PACKAGE_OpenSSL=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_JSONC=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_PCRE2=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_CURL=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_Iconv=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_BZip2=ON \
            \
            # Prefer NDK's zlib (present in sysroot)
            -D CMAKE_DISABLE_FIND_PACKAGE_ZLIB=OFF \
            \
            # Make sure we don't try to build apps/daemons/tools
            -D APP_CONFIGURE=OFF \
            -D ENABLE_CLAMONACC=OFF \
            -D ENABLE_APP=OFF \
            -D ENABLE_TESTS=OFF

      - name: Build libclamav
        working-directory: clamav
        run: |
          set -euo pipefail
          cmake --build build --config Release --target libclamav

      - name: Collect artifact (.so)
        run: |
          set -euo pipefail
          mkdir -p out/arm64-v8a
          # CMake puts libs under clamav/build/lib on recent versions
          cp -v clamav/build/lib/libclamav.so out/arm64-v8a/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libclamav-arm64-v8a
          path: out/arm64-v8a/libclamav.so
          compression-level: 6