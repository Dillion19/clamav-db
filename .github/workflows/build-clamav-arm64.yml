name: Build ClamAV (arm64-v8a)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/build-clamav-arm64.yml"
      - "jniLibs/arm64-v8a/**"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ANDROID_API: "24"
      ANDROID_ABI: "arm64-v8a"
      ANDROID_NDK_VERSION: "r26d"
      NDK_DIR: "${{ github.workspace }}/android-ndk-r26d"
      CLAMAV_TAG: "clamav-1.3.1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download & install Android NDK manually
        run: |
          set -euo pipefail
          cd ${{ github.workspace }}
          echo "⬇️ Downloading Android NDK r26d directly from Google..."
          curl -L https://dl.google.com/android/repository/android-ndk-r26d-linux.zip -o ndk.zip
          unzip -q ndk.zip
          rm ndk.zip
          echo "✅ Installed NDK at: ${NDK_DIR}"
          ls -la ${NDK_DIR}

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake pkg-config autoconf automake libtool zip unzip curl

      - name: Verify prebuilt third-party libs exist
        run: |
          set -euo pipefail
          ls -la jniLibs/arm64-v8a || true
          test -f jniLibs/arm64-v8a/libmspack.so || { echo "❌ Missing jniLibs/arm64-v8a/libmspack.so"; exit 1; }
          test -f jniLibs/arm64-v8a/libxml2.so   || { echo "❌ Missing jniLibs/arm64-v8a/libxml2.so"; exit 1; }

      - name: Prepare third-party folder
        run: |
          mkdir -p thirdparty/arm64-v8a
          cp -fv jniLibs/arm64-v8a/libmspack.so thirdparty/arm64-v8a/
          cp -fv jniLibs/arm64-v8a/libxml2.so   thirdparty/arm64-v8a/

      - name: Fetch ClamAV
        run: |
          git clone --depth=1 --branch "${CLAMAV_TAG}" https://github.com/Cisco-Talos/clamav.git clamav
          echo "✅ Cloned ClamAV $(git -C clamav rev-parse --short HEAD)"

      - name: Configure (CMake, arm64-v8a)
        working-directory: clamav
        run: |
          cmake -S . -B build -G Ninja \
            -D CMAKE_TOOLCHAIN_FILE="${NDK_DIR}/build/cmake/android.toolchain.cmake" \
            -D ANDROID_ABI="${ANDROID_ABI}" \
            -D ANDROID_PLATFORM="${ANDROID_API}" \
            -D CMAKE_BUILD_TYPE=Release \
            -D BUILD_SHARED_LIBS=ON \
            \
            -D CMAKE_PREFIX_PATH="${GITHUB_WORKSPACE}/thirdparty/arm64-v8a" \
            -D CMAKE_LIBRARY_PATH="${GITHUB_WORKSPACE}/thirdparty/arm64-v8a" \
            -D CMAKE_SYSTEM_LIBRARY_PATH="${GITHUB_WORKSPACE}/thirdparty/arm64-v8a" \
            \
            -D CMAKE_DISABLE_FIND_PACKAGE_OpenSSL=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_JSONC=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_PCRE2=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_CURL=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_Iconv=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_BZip2=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_ZLIB=OFF \
            \
            -D APP_CONFIGURE=OFF \
            -D ENABLE_CLAMONACC=OFF \
            -D ENABLE_APP=OFF \
            -D ENABLE_TESTS=OFF

      - name: Build libclamav
        working-directory: clamav
        run: |
          cmake --build build --config Release --target libclamav
          echo "✅ Build complete"
          find build -type f -name "libclamav.so" -print

      - name: Collect artifact (.so)
        run: |
          mkdir -p out/arm64-v8a
          cp -v clamav/build/lib*/libclamav.so out/arm64-v8a/ || echo "⚠️ lib not found in default path"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libclamav-arm64-v8a
          path: out/arm64-v8a/libclamav.so
          compression-level: 6

      - name: Copy into jniLibs for the app
        run: |
          mkdir -p jniLibs/arm64-v8a
          cp -fv out/arm64-v8a/libclamav.so jniLibs/arm64-v8a/libclamav.so

      - name: Commit updated binary (if changed)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(native): update libclamav.so (arm64-v8a)"
          file_pattern: "jniLibs/arm64-v8a/libclamav.so"
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          push_options: --force