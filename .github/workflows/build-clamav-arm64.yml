name: Build ClamAV (arm64-v8a)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/build-clamav-arm64.yml"
      - "jniLibs/arm64-v8a/**"

permissions:
  contents: write

concurrency:
  group: build-clamav-arm64
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ANDROID_API: "24"
      ANDROID_ABI: "arm64-v8a"
      ANDROID_NDK_VERSION: "27.3.13757024"
      NDK_DIR: "/usr/local/lib/android/sdk/ndk/27.3.13757024"
      CLAMAV_TAG: "clamav-1.3.1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
          add-to-path: true
          link-to-sdk: true
          local-cache: true

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake pkg-config autoconf automake libtool zip unzip

      - name: Verify prebuilt third-party libs exist
        run: |
          set -euo pipefail
          ls -la jniLibs/arm64-v8a || true
          test -f jniLibs/arm64-v8a/libmspack.so || { echo "❌ Missing jniLibs/arm64-v8a/libmspack.so"; exit 1; }
          test -f jniLibs/arm64-v8a/libxml2.so   || { echo "❌ Missing jniLibs/arm64-v8a/libxml2.so"; exit 1; }

      - name: Prepare third-party folder
        run: |
          set -euo pipefail
          mkdir -p thirdparty/arm64-v8a
          cp -fv jniLibs/arm64-v8a/libmspack.so thirdparty/arm64-v8a/
          cp -fv jniLibs/arm64-v8a/libxml2.so   thirdparty/arm64-v8a/

      - name: Fetch ClamAV
        run: |
          set -euo pipefail
          git clone --depth=1 --branch "${CLAMAV_TAG}" https://github.com/Cisco-Talos/clamav.git clamav
          echo "Cloned $(git -C clamav rev-parse --short HEAD)"

      - name: Configure (CMake, arm64-v8a)
        working-directory: clamav
        run: |
          set -euo pipefail
          cmake -S . -B build -G Ninja \
            -D CMAKE_TOOLCHAIN_FILE="${NDK_DIR}/build/cmake/android.toolchain.cmake" \
            -D ANDROID_ABI="${ANDROID_ABI}" \
            -D ANDROID_PLATFORM="${ANDROID_API}" \
            -D CMAKE_BUILD_TYPE=Release \
            -D BUILD_SHARED_LIBS=ON \
            \
            # Point CMake to our prebuilt libs
            -D CMAKE_PREFIX_PATH="${GITHUB_WORKSPACE}/thirdparty/arm64-v8a" \
            -D CMAKE_LIBRARY_PATH="${GITHUB_WORKSPACE}/thirdparty/arm64-v8a" \
            -D CMAKE_SYSTEM_LIBRARY_PATH="${GITHUB_WORKSPACE}/thirdparty/arm64-v8a" \
            \
            # Disable optional deps that caused repeated failures
            -D CMAKE_DISABLE_FIND_PACKAGE_OpenSSL=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_JSONC=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_PCRE2=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_CURL=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_Iconv=ON \
            -D CMAKE_DISABLE_FIND_PACKAGE_BZip2=ON \
            \
            # Keep zlib (from the NDK sysroot)
            -D CMAKE_DISABLE_FIND_PACKAGE_ZLIB=OFF \
            \
            # Don't build apps/daemons/tests
            -D APP_CONFIGURE=OFF \
            -D ENABLE_CLAMONACC=OFF \
            -D ENABLE_APP=OFF \
            -D ENABLE_TESTS=OFF

      - name: Build libclamav
        working-directory: clamav
        run: |
          set -euo pipefail
          cmake --build build --config Release --target libclamav
          echo "Built artifacts:"
          find build -maxdepth 2 -type f -name "libclamav.so" -print

      - name: Collect artifact (.so)
        run: |
          set -euo pipefail
          mkdir -p out/arm64-v8a
          # Handle possible lib or lib64 output dirs
          cp -v \
            clamav/build/lib/libclamav.so \
            out/arm64-v8a/ 2>/dev/null || \
          cp -v \
            clamav/build/lib64/libclamav.so \
            out/arm64-v8a/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libclamav-arm64-v8a
          path: out/arm64-v8a/libclamav.so
          compression-level: 6

      # OPTIONAL: write the freshly built .so back into the repo (jniLibs/arm64-v8a)
      - name: Copy into jniLibs for the app
        run: |
          set -euo pipefail
          mkdir -p jniLibs/arm64-v8a
          cp -fv out/arm64-v8a/libclamav.so jniLibs/arm64-v8a/libclamav.so

      - name: Commit updated binary (if changed)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(native): update libclamav.so (arm64-v8a)"
          file_pattern: "jniLibs/arm64-v8a/libclamav.so"
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          push_options: --force