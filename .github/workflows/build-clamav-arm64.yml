name: Build ClamAV (arm64-v8a)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/build-clamav-arm64.yml"
      - "app/src/main/jniLibs/arm64-v8a/**"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ANDROID_API: "24"
      ANDROID_ABI: "arm64-v8a"
      ANDROID_NDK_VERSION: "27.2.12479018"
      NDK_DIR: "/usr/local/lib/android/sdk/ndk/27.3.13757024"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build autoconf automake libtool pkg-config \
            unzip xz-utils

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}

      # ---- Bring in ClamAV source ----
      - name: Fetch ClamAV source
        run: |
          git clone --depth=1 https://github.com/Cisco-Talos/clamav.git
          cd clamav
          # Keep the tree minimal
          git submodule update --init --depth=1

      # ---- Stage your prebuilt third-party .so files (libmspack, libxml2) ----
      - name: Prepare third-party libs
        working-directory: clamav
        run: |
          mkdir -p thirdparty/${{ env.ANDROID_ABI }}
          # Copy from your repo's Android jniLibs folder
          cp -v ../app/src/main/jniLibs/${{ env.ANDROID_ABI }}/libmspack.so thirdparty/${{ env.ANDROID_ABI }}/
          cp -v ../app/src/main/jniLibs/${{ env.ANDROID_ABI }}/libxml2.so thirdparty/${{ env.ANDROID_ABI }}/

      # ---- Patch CMake to stop early OpenSSL (and other optional) detection ----
      - name: Disable freshclam/tools and neutralize optional find_package calls
        working-directory: clamav
        run: |
          set -euxo pipefail

          # Comment out optional apps that pull SSL/JSON/CURL/etc.
          sed -i 's/^[[:space:]]*add_subdirectory(.*freshclam.*)/# &/g' CMakeLists.txt || true
          sed -i 's/^[[:space:]]*add_subdirectory(.*clamonacc.*)/# &/g' CMakeLists.txt || true
          sed -i 's/^[[:space:]]*add_subdirectory(.*examples.*)/# &/g' CMakeLists.txt || true
          sed -i 's/^[[:space:]]*add_subdirectory(.*test.*)/# &/g' CMakeLists.txt || true
          sed -i 's/^[[:space:]]*add_subdirectory(.*milter.*)/# &/g' CMakeLists.txt || true

          # Neutralize top-level find_package calls that can fail on CI
          for PKG in OpenSSL CURL JSONC PCRE2 Iconv; do
            sed -i "s/^[[:space:]]*find_package(${PKG}.*/# find_package(${PKG}) disabled for Android/g" CMakeLists.txt || true
          done

      # ---- Configure & build libclamav only (shared) ----
      - name: Configure (CMake, arm64-v8a)
        working-directory: clamav
        env:
          ANDROID_NDK_HOME: ${{ env.NDK_DIR }}
        run: |
          set -euxo pipefail

          # Toolchain file from NDK
          TOOLCHAIN="$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake"

          # Library hints for our prebuilt .so files
          export LD_LIBRARY_PATH="$PWD/thirdparty/${{ env.ANDROID_ABI }}:$LD_LIBRARY_PATH"

          cmake -S . -B build \
            -G Ninja \
            -D CMAKE_TOOLCHAIN_FILE="${TOOLCHAIN}" \
            -D ANDROID_ABI=${{ env.ANDROID_ABI }} \
            -D ANDROID_PLATFORM=android-${{ env.ANDROID_API }} \
            -D CMAKE_BUILD_TYPE=Release \
            -D BUILD_SHARED_LIBS=ON \
            \
            # turn OFF optional products that drag in many deps
            -D ENABLE_APP=OFF \
            -D ENABLE_TOOLS=OFF \
            -D ENABLE_TESTS=OFF \
            -D ENABLE_EXAMPLES=OFF \
            -D ENABLE_MILTER=OFF \
            -D ENABLE_FRESHCLAM=OFF \
            -D ENABLE_CLAMONACC=OFF \
            \
            # crypto / net / regex / charsets disabled on Android build
            -D ENABLE_OPENSSL=OFF \
            -D ENABLE_LIBCURL=OFF \
            -D ENABLE_JSON=OFF \
            -D ENABLE_JSON_SHARED=OFF \
            -D ENABLE_PCRE2=OFF \
            -D ENABLE_ICONV=OFF \
            \
            # we still want XML + mspack + zlib support
            -D ENABLE_XML=ON \
            -D ENABLE_ZLIB=ON \
            \
            # Hint locations for our staged binaries
            -D LIBXML2_LIBRARY="$PWD/thirdparty/${{ env.ANDROID_ABI }}/libxml2.so" \
            -D LIBXML2_LIBRARIES="$PWD/thirdparty/${{ env.ANDROID_ABI }}/libxml2.so" \
            -D MSPACK_LIBRARY="$PWD/thirdparty/${{ env.ANDROID_ABI }}/libmspack.so" \
            -D MSPACK_LIBRARIES="$PWD/thirdparty/${{ env.ANDROID_ABI }}/libmspack.so"

      - name: Build (arm64-v8a)
        working-directory: clamav
        run: |
          cmake --build build --config Release -j$(nproc)

      - name: Collect libclamav.so
        run: |
          mkdir -p out/${{ env.ANDROID_ABI }}
          cp -v clamav/build/lib/libclamav.so out/${{ env.ANDROID_ABI }}/

      - name: Upload artifact (libclamav)
        uses: actions/upload-artifact@v4
        with:
          name: libclamav-${{ env.ANDROID_ABI }}
          path: out/${{ env.ANDROID_ABI }}/libclamav.so